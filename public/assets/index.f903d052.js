var ye=Object.defineProperty;var ke=(e,s,t)=>s in e?ye(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t;var _=(e,s,t)=>(ke(e,typeof s!="symbol"?s+"":s,t),t);import{A as ve,u as Se,T as q,E as Q,L as g,C,a as z,b as D,S as v,c as l,R as i,f as V,G as F,l as U,d as Be,r as H,e as W}from"./vendor.539bc9b5.js";const Ie=function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const h of n)if(h.type==="childList")for(const b of h.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&o(b)}).observe(document,{childList:!0,subtree:!0});function t(n){const h={};return n.integrity&&(h.integrity=n.integrity),n.referrerpolicy&&(h.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?h.credentials="include":n.crossorigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function o(n){if(n.ep)return;n.ep=!0;const h=t(n);fetch(n.href,h)}};Ie();const c=40,L=40,$=15,X=13,G=800,j=600,E=15,T=13,Le="/hall",Ye="/room",Ce="/game";var I=new class extends ve{constructor(){super({width:G,height:j,backgroundColor:16777215,antialias:!0});_(this,"stack",[]);this.ticker.add(()=>{const s=function(t){t.sortChildren(),t.children.forEach(o=>{o.onUpdate&&o.onUpdate(),o.children.length>0&&s(o)})};s(this.stage),Se(performance.now())})}push(s){console.info("app.push",s.name);const t=new s,o=this.stack[this.stack.length-1];o&&o.onLeave().then(()=>{this.stage.removeChild(o)}),this.stack.push(t),this.stage.addChild(t),t.onEnter()}back(){console.info("app.back");debugger;const s=this.stack.pop();s&&s.onLeave().then(()=>{this.stage.removeChild(s),s.onDestroy()}),this.stage.addChild(this.stack[this.stack.length-1]),this.stack[this.stack.length-1].onEnter()}reselaunch(){const s=this.stack.pop();s.destory(),this.stage.removeChild(s);const t=new s.__proto__.constructor;this.stack.push(t),this.stage.addChild(t),t.onEnter()}changeStage(s,t){s&&new q(s).to({alpha:0},1e3).easing(Q.Quadratic.Out).start(),t.alpha=0,new q(t).to({alpha:1},1e3).easing(Q.Quadratic.Out).start()}};const Fe=["assets/bazzi.png","assets/bg.jpg","assets/btn_blue.png","assets/btn_create_room.png","assets/btn_next_page.png","assets/btn_pre_page.png","assets/btn_room_ready.png","assets/btn_room_start.png","assets/common_gate.png","assets/custom_bubble_100.png","assets/custom_bubble_101.png","assets/custom_bubble_102.png","assets/custom_bubble_103.png","assets/custom_bubble_104.png","assets/custom_bubble_105.png","assets/custom_bubble_106.png","assets/custom_bubble_107.png","assets/custom_bubble_108.png","assets/custom_bubble_95.png","assets/custom_bubble_96.png","assets/custom_bubble_97.png","assets/custom_bubble_98.png","assets/custom_bubble_99.png","assets/hall.png","assets/item_58.png","assets/item_59.png","assets/item_60.png","assets/item_61.png","assets/item_62.png","assets/item_63.png","assets/item_64.png","assets/item_65.png","assets/item_66.png","assets/item_67.png","assets/item_68.png","assets/item_69.png","assets/item_70.png","assets/item_71.png","assets/item_72.png","assets/item_73.png","assets/item_74.png","assets/item_75.png","assets/item_76.png","assets/item_77.png","assets/item_78.png","assets/item_79.png","assets/loading.png","assets/map_flopy_tile2.png","assets/map_pirate_object1.png","assets/map_pirate_object5.png","assets/map_pirate_tile2.png","assets/map_pirate_tile6.png","assets/role_buzzi.png","assets/role_cappi.png","assets/role_dao.png","assets/role_marid.png","assets/role_selected.png","assets/room_card_bg.png","assets/room_card_default_img.png","assets/room_card_status_in_game.png","assets/room_card_status_waiting.png","assets/room_player_card.png","assets/room_player_card_none.png","assets/unit_bazzi.png","assets/unit_bombwater.png","assets/unit_cappi.png","assets/unit_dao.png","assets/unit_luxmarid.png","assets/unit_marid.png"];var m;(function(e){e.bazzi="assets/bazzi.png",e.bg="assets/bg.jpg",e.btn_blue="assets/btn_blue.png",e.btn_create_room="assets/btn_create_room.png",e.btn_next_page="assets/btn_next_page.png",e.btn_pre_page="assets/btn_pre_page.png",e.btn_room_ready="assets/btn_room_ready.png",e.btn_room_start="assets/btn_room_start.png",e.common_gate="assets/common_gate.png",e.custom_bubble_100="assets/custom_bubble_100.png",e.custom_bubble_101="assets/custom_bubble_101.png",e.custom_bubble_102="assets/custom_bubble_102.png",e.custom_bubble_103="assets/custom_bubble_103.png",e.custom_bubble_104="assets/custom_bubble_104.png",e.custom_bubble_105="assets/custom_bubble_105.png",e.custom_bubble_106="assets/custom_bubble_106.png",e.custom_bubble_107="assets/custom_bubble_107.png",e.custom_bubble_108="assets/custom_bubble_108.png",e.custom_bubble_95="assets/custom_bubble_95.png",e.custom_bubble_96="assets/custom_bubble_96.png",e.custom_bubble_97="assets/custom_bubble_97.png",e.custom_bubble_98="assets/custom_bubble_98.png",e.custom_bubble_99="assets/custom_bubble_99.png",e.hall="assets/hall.png",e.item_58="assets/item_58.png",e.item_59="assets/item_59.png",e.item_60="assets/item_60.png",e.item_61="assets/item_61.png",e.item_62="assets/item_62.png",e.item_63="assets/item_63.png",e.item_64="assets/item_64.png",e.item_65="assets/item_65.png",e.item_66="assets/item_66.png",e.item_67="assets/item_67.png",e.item_68="assets/item_68.png",e.item_69="assets/item_69.png",e.item_70="assets/item_70.png",e.item_71="assets/item_71.png",e.item_72="assets/item_72.png",e.item_73="assets/item_73.png",e.item_74="assets/item_74.png",e.item_75="assets/item_75.png",e.item_76="assets/item_76.png",e.item_77="assets/item_77.png",e.item_78="assets/item_78.png",e.item_79="assets/item_79.png",e.loading="assets/loading.png",e.map_flopy_tile2="assets/map_flopy_tile2.png",e.map_pirate_object1="assets/map_pirate_object1.png",e.map_pirate_object5="assets/map_pirate_object5.png",e.map_pirate_tile2="assets/map_pirate_tile2.png",e.map_pirate_tile6="assets/map_pirate_tile6.png",e.role_buzzi="assets/role_buzzi.png",e.role_cappi="assets/role_cappi.png",e.role_dao="assets/role_dao.png",e.role_marid="assets/role_marid.png",e.role_selected="assets/role_selected.png",e.room_card_bg="assets/room_card_bg.png",e.room_card_default_img="assets/room_card_default_img.png",e.room_card_status_in_game="assets/room_card_status_in_game.png",e.room_card_status_waiting="assets/room_card_status_waiting.png",e.room_player_card="assets/room_player_card.png",e.room_player_card_none="assets/room_player_card_none.png",e.unit_bazzi="assets/unit_bazzi.png",e.unit_bombwater="assets/unit_bombwater.png",e.unit_cappi="assets/unit_cappi.png",e.unit_dao="assets/unit_dao.png",e.unit_luxmarid="assets/unit_luxmarid.png",e.unit_marid="assets/unit_marid.png"})(m||(m={}));let re;function M(){const e=g.shared.resources[m.btn_blue].texture;return re=re||{blueBtn:e,btn_pre_page:g.shared.resources[m.btn_pre_page].texture,btn_next_page:g.shared.resources[m.btn_next_page].texture,btn_create_room:g.shared.resources[m.btn_create_room].texture}}class O extends C{constructor(s,t,o,n){super();const h=new z(s,new D(Object.assign({align:"center",fontSize:16,fill:16777215,strokeThickness:3,fontWeight:"bold",letterSpacing:3,stroke:5422079},n||{})));h.anchor.set(.5,.5);const b=M().blueBtn,d=new v(new l(b,new i(0,0,20,20))),u=new v(new l(b,new i(b.width-20,0,20,20))),a=new v(new l(b,new i(0,b.height-20,20,20))),f=new v(new l(b,new i(b.width-20,b.height-20,20,20))),p=new v(new l(b,new i(0,20,20,b.height-40))),w=new v(new l(b,new i(b.width-20,20,20,b.height-40))),k=new v(new l(b,new i(20,0,b.width-40,20))),y=new v(new l(b,new i(20,b.height-20,b.width-40,20))),B=new v(new l(b,new i(20,20,b.width-40,b.height-40)));d.x=a.x=p.x=0,d.y=k.y=u.y=0,k.x=B.x=y.x=20,a.y=y.y=f.y=o-20,u.x=w.x=f.x=t-20,B.y=p.y=w.y=20,B.width=k.width=y.width=t-40,B.height=p.height=w.height=o-40,this.addChild(d),this.addChild(u),this.addChild(a),this.addChild(f),this.addChild(p),this.addChild(w),this.addChild(k),this.addChild(y),this.addChild(B),t=Math.max(h.width+20,t),o=Math.max(h.height+20,o),this.interactive=!0,this.buttonMode=!0,this.on("pointerdown",()=>this.onHover()),this.on("pointerup",()=>this.reset()),this.on("pointerleave",()=>this.reset()),this.on("pointerout",()=>this.reset()),this.on("touchendoutside",()=>this.reset()),this.on("touchend",()=>this.reset()),h.x=this.width/2,h.y=this.height/2,this.addChild(h)}onHover(){const s=new V.ColorMatrixFilter;s.sepia(!0),s.saturate(4,!0),s.brightness(1.15,!0),this.filters=[s]}reset(){this.filters=[]}}class P extends C{constructor(){super();_(this,"bg");_(this,"bgImg");this.bg=new F,this.bgImg=new v,this.addChild(this.bg),this.addChild(this.bgImg)}get width(){return G}get height(){return j}set background(s){this.bg.beginFill(s),this.bg.drawRect(0,0,this.width,this.height),this.bg.endFill()}set backgroundImage(s){s&&(this.bgImg.texture=s)}onEnter(){this.alpha=0,new q(this).to({alpha:1},150).easing(Q.Quadratic.Out).start()}async onLeave(){return new Promise(s=>{new q(this).to({alpha:0},150).easing(Q.Quadratic.Out).start().onComplete(()=>{s(void 0)})})}onDestroy(){}}var Y={name:U.parse(location.search.replace("?","")).name,roomId:""},ee=window.io;class ie extends F{constructor(s,t,o=0,n=.2){super();_(this,"texts",[]);_(this,"boxHeight");this.beginFill(o,n),this.drawRoundedRect(0,0,s,t,4),this.endFill(),this.boxHeight=t;const h=new F;h.beginFill(16777215),h.drawRoundedRect(0,0,s,t,4),h.endFill(),this.mask=h,this.addChild(h)}push(s){const t=new z(`[${Be().format("HH:MM:ss")}] ${s}`,new D({align:"left",fontSize:14,wordWrapWidth:this.width-8,wordWrap:!0,breakWords:!0,fill:H([255/255,255/255,255/255])}));t.x=4,t.y=4,this.addChild(t),this.texts.push(t);let o=0;this.texts=this.texts.filter((n,h)=>(n.x=8,n.y=this.boxHeight-8-n.height-o,o=o+n.height+4,n.alpha=(10-h)/10,n.y+n.height<0?(n.destroy(),this.removeChild(n),!1):!0))}}var R;(function(e){e.role_marid="role_marid",e.role_buzzi="role_buzzi",e.role_dao="role_dao",e.role_cappi="role_cappi"})(R||(R={}));let ne;function ae(){return ne=ne||{role_marid:g.shared.resources[m.role_marid].texture,role_buzzi:g.shared.resources[m.role_buzzi].texture,role_dao:g.shared.resources[m.role_dao].texture,role_cappi:g.shared.resources[m.role_cappi].texture,role_selected:g.shared.resources[m.role_selected].texture}}class Ae extends C{constructor(s=R.role_marid){super();_(this,"onSelectedCallback",()=>null);_(this,"_activeRole",R.role_marid);_(this,"map",{});_(this,"selectedTag");_(this,"hightFilter");Object.values(R).map((o,n)=>{const h=new v(ae()[o]);h.x=n%4*(h.width+8),h.y=Math.floor(n/4)*(h.height+8),h.interactive=!0,h.on("click",()=>{this.activeRole=o,this.onSelectedCallback(o)}),this.addChild(h),this.map[o]=h}),this.selectedTag=new v(ae().role_selected),this.selectedTag.visible=!1,this.addChild(this.selectedTag),this.activeRole=s;const t=this.hightFilter=new V.ColorMatrixFilter;t.sepia(!0),t.saturate(4,!0),t.brightness(1.15,!0)}set activeRole(s){const t=this.map[this._activeRole];t&&(t.filters=[]);const o=this.map[s];if(o){this.selectedTag.visible=!0,this.selectedTag.x=o.x+30,this.selectedTag.y=o.y+15;const n=new V.ColorMatrixFilter;n.sepia(!0),n.saturate(4,!0),n.brightness(1.15,!0),o.filters=[n]}else this.selectedTag.visible=!1;this._activeRole=s}get activeRole(){return this._activeRole}onSelected(s){this.onSelectedCallback=s}}var Z;(function(e){e[e.WAITING=0]="WAITING",e[e.IN_GAME=1]="IN_GAME"})(Z||(Z={}));var J;(function(e){e[e.PENDING=0]="PENDING",e[e.READY=1]="READY"})(J||(J={}));var le;(function(e){e[e.GAME_PROPS_ALIVE=1]="GAME_PROPS_ALIVE",e[e.GAME_PROPS_DEAD=2]="GAME_PROPS_DEAD"})(le||(le={}));var K;(function(e){e[e.TGamePropEnum_NONE=0]="TGamePropEnum_NONE",e[e.TGamePropEnum_SHOSE=1]="TGamePropEnum_SHOSE",e[e.TGamePropEnum_LOTION=2]="TGamePropEnum_LOTION",e[e.TGamePropEnum_BUBBLES=3]="TGamePropEnum_BUBBLES"})(K||(K={}));var A;(function(e){e.Left="Left",e.Right="Right",e.Up="Up",e.Down="Down",e.None="None"})(A||(A={}));function te(){const e=g.shared.resources["assets/bazzi.png"].texture;return{shadow:new l(e,new i(395,562,32,15))}}let he;function se(){const e=g.shared.resources[m.room_player_card].texture,s=g.shared.resources[m.room_player_card_none].texture,t=g.shared.resources[m.unit_bazzi].texture,o=g.shared.resources[m.unit_dao].texture,n=g.shared.resources[m.unit_cappi].texture,h=g.shared.resources[m.unit_luxmarid].texture;return he=he||{playerCard:new l(e),playerCardNone:new l(s),role_buzzi:new l(t,new i(382,67,44,56)),role_dao:new l(o,new i(385,67,52,55)),role_cappi:new l(n,new i(348,43,52,55)),role_marid:new l(h,new i(281,135,50,58))}}class ze extends C{constructor(s,t){super();_(this,"person");const o=new v(s?se().playerCard:se().playerCardNone);if(this.addChild(o),t){const n=t.isMaster?"\u623F \u4E3B":"\u51C6 \u5907",h=t.status==J.READY||t.isMaster,b=new z(n,new D({align:"center",fontSize:12,fill:h?"#fff":H([122/255,191/255,219/255])}));b.x=(o.width-b.width)/2,b.y=124;const d=new z(t.name,new D({align:"center",fontSize:12,fill:"#fff"}));d.x=(o.width-d.width)/2,d.y=106;const u=this.person=new v(se()[t.role]);u.x=(o.width-u.width)/2,u.y=30;const a=new v(te().shadow);a.x=o.width/2-a.width/2,a.y=75,this.addChild(a),this.addChild(u),this.addChild(b),this.addChild(d)}}}class oe extends v{constructor(s,t){super(s);_(this,"baseTexture");_(this,"hoverTexture");this.baseTexture=s,this.hoverTexture=t,this.interactive=!0,this.buttonMode=!0,this.on("pointerdown",()=>this.onHover()),this.on("pointerup",()=>this.reset()),this.on("pointerleave",()=>this.reset()),this.on("pointerout",()=>this.reset()),this.on("touchendoutside",()=>this.reset()),this.on("touchend",()=>this.reset())}onHover(){if(this.hoverTexture)this.texture=this.hoverTexture;else{const s=new V.ColorMatrixFilter;s.sepia(!0),s.saturate(4,!0),s.brightness(1.15,!0),this.filters=[s]}}reset(){this.baseTexture&&(this.texture=this.baseTexture,this.filters=[])}}let de;function De(){const e=g.shared.resources[m.loading].texture;return de=de||[new l(e,new i(0,0,100,100)),new l(e,new i(100*1,0,100,100)),new l(e,new i(100*2,0,100,100)),new l(e,new i(100*3,0,100,100)),new l(e,new i(100*4,0,100,100)),new l(e,new i(100*5,0,100,100)),new l(e,new i(100*6,0,100,100)),new l(e,new i(100*7,0,100,100))]}class Pe extends C{constructor(){super();const s=new F;s.beginFill(0),s.drawRect(0,0,1334,750),s.interactive=!0,s.alpha=0;const t=new W(De());t.loop=!0,t.animationSpeed=.3,t.anchor.set(.5,.5),t.x=1334/2,t.y=750/2,t.play(),this.addChild(s),this.addChild(t)}}let N;var Ge={showLoading(){N=new Pe,I.stage.addChild(N)},hideLoading(){N&&I.stage.removeChild(N)},toast(e){const s=120,t=new z(e,new D({align:"left",fontSize:14,wordWrapWidth:s-10,wordWrap:!0,breakWords:!0,fill:16777215})),o=new F;o.beginFill(0,.2),o.drawRoundedRect(0,0,s+15,t.height+15,8),t.anchor.set(.5,.5),t.x=o.width/2,t.y=o.height/2,o.addChild(t),o.x=G/2-o.width/2,o.y=j/2-o.height/2,I.stage.addChild(o),setTimeout(()=>{I.stage.removeChild(o)},1500)}};let ce;function x(){const e=g.shared.resources["assets/custom_bubble_95.png"].texture,s=g.shared.resources["assets/custom_bubble_96.png"].texture,t=g.shared.resources["assets/custom_bubble_97.png"].texture,o=g.shared.resources["assets/custom_bubble_98.png"].texture,n=g.shared.resources["assets/custom_bubble_99.png"].texture,h=g.shared.resources["assets/custom_bubble_100.png"].texture,b=g.shared.resources["assets/custom_bubble_101.png"].texture,d=g.shared.resources["assets/custom_bubble_102.png"].texture,u=g.shared.resources["assets/custom_bubble_103.png"].texture,a=g.shared.resources["assets/custom_bubble_104.png"].texture,f=g.shared.resources["assets/unit_bombwater.png"].texture;function p(w){return[new l(w,new i(13,21,44,41)),new l(w,new i(85,21,44,41)),new l(w,new i(158,21,44,41))]}return ce=ce||{empty:new l(f,new i(0,0,40,40)),RANBOW:p(e),BLUE:p(s),BLACK:p(t),RED:p(o),DARK_RED:p(n),RED_AND_BLUE:p(h),SOAP:p(b),Skulls:p(d),black_flame:p(u),ocean:p(a),shodow:new l(f,new i(196,42,42,39)),boom_ani_3:new l(f,new i(143,115,39,37)),boom_ani_2:new l(f,new i(85,114,38,38)),boom_ani_1:new l(f,new i(28,114,38,38)),boom_up_1:new l(f,new i(28,344,38,38)),boom_up_2:new l(f,new i(86,344,38,38)),boom_up_3:new l(f,new i(145,344,38,38)),boom_up_4:new l(f,new i(202,344,38,38)),boom_up_end_1:new l(f,new i(28,185,38,38)),boom_up_end_2:new l(f,new i(86,185,38,38)),boom_up_end_3:new l(f,new i(145,185,38,38)),boom_up_end_4:new l(f,new i(202,185,38,38)),boom_down_1:new l(f,new i(28,419,38,38)),boom_down_2:new l(f,new i(86,419,38,38)),boom_down_3:new l(f,new i(145,419,38,38)),boom_down_4:new l(f,new i(202,419,38,38)),boom_down_end_1:new l(f,new i(28,260,38,38)),boom_down_end_2:new l(f,new i(86,260,38,38)),boom_down_end_3:new l(f,new i(145,260,38,38)),boom_down_end_4:new l(f,new i(202,260,38,38)),boom_left_1:new l(f,new i(446,419,38,38)),boom_left_2:new l(f,new i(389,419,38,38)),boom_left_3:new l(f,new i(335,419,38,38)),boom_left_4:new l(f,new i(271,419,38,38)),boom_left_end_1:new l(f,new i(28,260,38,38)),boom_left_end_2:new l(f,new i(86,260,38,38)),boom_left_end_3:new l(f,new i(145,260,38,38)),boom_left_end_4:new l(f,new i(202,260,38,38)),boom_right_1:new l(f,new i(446,344,38,38)),boom_right_2:new l(f,new i(389,344,38,38)),boom_right_3:new l(f,new i(335,344,38,38)),boom_right_4:new l(f,new i(271,344,38,38)),boom_right_end_1:new l(f,new i(28,185,38,38)),boom_right_end_2:new l(f,new i(86,185,38,38)),boom_right_end_3:new l(f,new i(145,185,38,38)),boom_right_end_4:new l(f,new i(202,185,38,38))}}class ue extends C{constructor(s,t,o,n){super();_(this,"power",1);_(this,"gridX");_(this,"gridY");_(this,"srpite");_(this,"shodow");const h=this.shodow=new v(x().shodow);h.anchor.set(.5,.5),h.y=3,this.addChild(h);const b=this.srpite=new W(s,!0);this.power=n,this.gridX=t,this.gridY=o,this.x=t*c+c/2,this.y=o*L+L/2-5,b.loop=!0,b.animationSpeed=.1,b.anchor.set(.5,.5),b.play(),this.addChild(b)}boom(s,t,o,n){!this.parent||(this.srpite.textures=[x().boom_ani_1,x().boom_ani_2,x().boom_ani_3,x().empty],this.srpite.gotoAndPlay(0),this.srpite.loop=!1,this.removeChild(this.shodow),this.boomLeft(s),this.boomRight(t),this.boomDown(n),this.boomUp(o),setTimeout(()=>{this.parent&&this.parent.removeChild(this)},300))}async boomLeft(s){for(let t=0;t<=s;t++){const o=new W([x().boom_left_2,x().boom_left_1,x().boom_left_1,x().boom_left_1,x().boom_left_3,x().boom_left_4,x().boom_left_end_4,x().empty],!0);o.width=c,o.height=L,o.anchor.set(.5,.5),o.y=0,o.x=-t*L,o.animationSpeed=.3,o.loop=!1,o.play(),this.addChild(o),await new Promise(n=>setTimeout(n,10))}}async boomRight(s){for(let t=0;t<=s;t++){const o=new W([x().boom_right_2,x().boom_right_1,x().boom_right_1,x().boom_right_1,x().boom_right_3,x().boom_right_4,x().boom_right_end_4,x().empty],!0);o.width=c,o.height=L,o.anchor.set(.5,.5),o.y=0,o.x=t*L,o.animationSpeed=.3,o.loop=!1,o.play(),this.addChild(o),await new Promise(n=>setTimeout(n,10))}}async boomUp(s){for(let t=0;t<=s;t++){const o=new W([x().boom_up_2,x().boom_up_1,x().boom_up_1,x().boom_up_1,x().boom_up_3,x().boom_up_4,x().boom_up_end_4,x().empty],!0);o.width=c,o.height=L,o.anchor.set(.5,.5),o.x=0,o.y=-t*L,o.animationSpeed=.3,o.loop=!1,o.play(),this.addChild(o),await new Promise(n=>setTimeout(n,10))}}async boomDown(s){for(let t=0;t<=s;t++){const o=new W([x().boom_down_2,x().boom_down_1,x().boom_down_1,x().boom_down_1,x().boom_down_3,x().boom_down_4,x().boom_down_end_4,x().empty],!0);o.width=c,o.height=L,o.anchor.set(.5,.5),o.x=0,o.y=t*L,o.animationSpeed=.3,o.loop=!1,o.play(),this.addChild(o),await new Promise(n=>setTimeout(n,10))}}}class Re extends v{constructor(s){super();const t=140,o=40,n=38,h=30;s.forEach((b,d)=>{const u=new F;u.lineStyle({width:1,color:17056}),u.beginFill(484807),u.drawRoundedRect(0,0,t,o,8),u.endFill(),u.lineStyle({width:2,color:1799887}),u.beginFill(15508),u.drawRoundedRect(5,5,n,h,3),u.endFill();const a=new v(b.icon);a.x=5,a.y=5,a.width=n-4,a.height=h-4,u.addChild(a);const f=new z(b.name,new D({align:"center",fontSize:12,fill:16777215,letterSpacing:1}));f.x=n+10+10,f.y=o/2-f.height/2,u.addChild(f),u.y=(o+6)*d,this.addChild(u)})}}class He extends C{constructor(){super();_(this,"timer");_(this,"timeRect");_(this,"time");const s=140,t=30;let o=this.timeRect=new F;o.lineStyle({width:3,color:H([0/255,72/255,158/255])}),o.beginFill(H([2/255,69/255,144/255])),o.drawRoundedRect(0,0,s,t,8),o.endFill();const n=new z("\u5012\u8BA1\u65F6\u95F4",new D({align:"center",fontSize:14,fill:H([122/255,191/255,219/255]),dropShadow:!0,dropShadowAlpha:.7,dropShadowBlur:3,letterSpacing:1}));n.x=10,n.y=o.height/2-n.height/2,o.addChild(n);let h=300;clearInterval(this.timer),this.timer=setInterval(()=>{h<1&&clearInterval(this.timer),o.removeChild(this.time);let b=Math.floor(h/60),d=h%60,u=b<10?"0"+b:b,a=d<10?"0"+d:d,f=u+":"+a;const p=this.time=new z(f,new D({align:"center",fontSize:14,fill:H([235/255,174/255,23/255]),dropShadow:!0,dropShadowAlpha:.7,dropShadowBlur:3,letterSpacing:1}));o.addChild(p),p.x=n.width+15,p.y=o.height/2-n.height/2,h-=1},1e3),this.addChild(o)}}const r=(e,s,t,o)=>({floor:e,top:s,type:t,prop:o,hasdestoryed:s==""}),be=[[r("floor2","",!1),r("floor4","",!1),r("floor2","box1",!1,"item_61"),r("floor4","box1",!1,"item_62"),r("floor2","box1",!1,"item_63"),r("floor4","b1",!0),r("floor2","box1",!1,"item_61"),r("floor4","box1",!1,"item_62"),r("floor2","box1",!1,"item_63"),r("floor4","b1",!0),r("floor2","box1",!1,"item_61"),r("floor4","box1",!1,"item_61"),r("floor2","box1",!1,"item_61"),r("floor4","",!1),r("floor2","",!1)],[r("floor4","",!1),r("floor2","stone",!0),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!0),r("floor2","box1",!1),r("floor4","box1",!0),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","stone",!0),r("floor4","",!1)],[r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1)],[r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1)],[r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","pirate3",!0),r("floor4","",!0),r("floor2","",!0),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1)],[r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1)],[r("floor2","box1",!1),r("floor4","stone",!0),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","stone",!0),r("floor2","box1",!1)],[r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!0),r("floor4","box1",!0),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1)],[r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","pirate3",!0),r("floor4","",!0),r("floor2","",!0),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1)],[r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1)],[r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1)],[r("floor4","",!1),r("floor2","stone",!0),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","stone",!0),r("floor4","",!1)],[r("floor2","",!1),r("floor4","",!1),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","b1",!0),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","b1",!0),r("floor2","box1",!1),r("floor4","box1",!1),r("floor2","box1",!1),r("floor4","",!1),r("floor2","",!1)]];let pe;function We(){const e=g.shared.resources["assets/bazzi.png"].texture;return pe=pe||{down_4:new l(e,new i(154,352,42,55)),down_3:new l(e,new i(154,279,42,57)),down_2:new l(e,new i(154,210,42,55)),down_1:new l(e,new i(154,137,42,57)),down_5:new l(e,new i(382,67,44,56)),up_1:new l(e,new i(81,137,44,57)),up_2:new l(e,new i(81,210,44,55)),up_3:new l(e,new i(81,280,44,56)),up_4:new l(e,new i(81,352,44,55)),up_5:new l(e,new i(311,67,44,56)),right_1:new l(e,new i(225,207,42,58)),right_2:new l(e,new i(294,207,44,58)),right_3:new l(e,new i(366,207,43,58)),right_4:new l(e,new i(438,207,41,58)),right_5:new l(e,new i(450,67,42,56))}}let fe;function $e(){const e=g.shared.resources[m.unit_cappi].texture;return fe=fe||{down_4:new l(e,new i(137,130,52,56)),down_3:new l(e,new i(137,201,52,56)),down_2:new l(e,new i(137,272,52,56)),down_1:new l(e,new i(137,343,52,56)),down_5:new l(e,new i(348,43,52,56)),up_1:new l(e,new i(66,131,53,56)),up_2:new l(e,new i(66,201,52,56)),up_3:new l(e,new i(66,272,52,56)),up_4:new l(e,new i(66,342,52,57)),up_5:new l(e,new i(276,44,52,55)),right_1:new l(e,new i(250,140,49,56)),right_2:new l(e,new i(325,140,49,56)),right_3:new l(e,new i(396,140,49,57)),right_4:new l(e,new i(465,140,49,57)),right_5:new l(e,new i(419,43,45,55))}}let _e;function Xe(){const e=g.shared.resources[m.unit_marid].texture;return _e=_e||{right_5:new l(e,new i(357,137,46,55)),right_4:new l(e,new i(421,207,46,57)),right_3:new l(e,new i(350,207,46,57)),right_2:new l(e,new i(280,207,46,57)),right_1:new l(e,new i(209,208,46,56)),up_5:new l(e,new i(210,137,50,55)),up_4:new l(e,new i(64,347,49,58)),up_3:new l(e,new i(64,278,49,58)),up_2:new l(e,new i(64,206,49,58)),up_1:new l(e,new i(64,136,49,57)),down_5:new l(e,new i(281,137,50,55)),down_4:new l(e,new i(135,348,49,57)),down_3:new l(e,new i(135,279,49,57)),down_2:new l(e,new i(135,207,49,57)),down_1:new l(e,new i(135,137,49,57))}}let ge;function je(){const e=g.shared.resources[m.unit_dao].texture;return ge=ge||{right_5:new l(e,new i(463,67,42,55)),right_4:new l(e,new i(473,135,44,57)),right_3:new l(e,new i(404,135,42,57)),right_2:new l(e,new i(334,137,42,55)),right_1:new l(e,new i(263,137,42,55)),up_5:new l(e,new i(314,67,52,55)),up_1:new l(e,new i(63,135,51,57)),up_2:new l(e,new i(66,206,49,57)),up_3:new l(e,new i(66,277,49,57)),up_4:new l(e,new i(67,348,48,57)),down_4:new l(e,new i(138,348,48,57)),down_3:new l(e,new i(138,277,48,57)),down_2:new l(e,new i(138,206,48,57)),down_1:new l(e,new i(138,135,48,57)),down_5:new l(e,new i(385,67,52,55))}}function Ke(){return{[R.role_buzzi]:We(),[R.role_cappi]:$e(),[R.role_marid]:Xe(),[R.role_dao]:je()}}class qe extends C{constructor(s,t,o,n,h=!1){super();_(this,"hasChange",!1);_(this,"keyEvent",[]);_(this,"gridX",0);_(this,"gridY",0);_(this,"sprite");_(this,"textureMap");_(this,"booms");_(this,"speed",2);_(this,"speedLimit",10);_(this,"power",1);_(this,"powerLimit",10);_(this,"popCount",2);_(this,"popCountLimit",1);_(this,"bubbleStyle","RANBOW");_(this,"_moveTarget",A.None);_(this,"isMe");this.zIndex=2,this.isMe=h,this.gridX=s,this.gridY=t,this.x=s*c+c/2,this.y=t*L+L/2,this.textureMap=Ke()[n];const b=new v(te().shadow);if(b.anchor.set(.5,-.2),this.addChild(b),this.sprite=new W([this.textureMap.down_1,this.textureMap.down_2,this.textureMap.down_3,this.textureMap.down_4,this.textureMap.down_5],!0),this.sprite.loop=!0,this.sprite.animationSpeed=.17,this.sprite.anchor.set(.5,.75),this.sprite.gotoAndStop(4),this.addChild(this.sprite),h){const d=new v(g.shared.resources[m.common_gate].texture);d.scale.set(.3,.3),d.anchor.set(.5,.5),d.x=0,d.y=-d.height-20,this.addChild(d)}else{const d=new z(o,new D({fontSize:14,wordWrap:!0,breakWords:!0,fill:16777215,strokeThickness:3}));d.anchor.set(.5,.5),d.y=-this.sprite.height*.75-15,this.addChild(d)}}showTag(){}set moveTarget(s){if(this._moveTarget!=s)switch(this.hasChange=!0,this._moveTarget=s,this.moveTarget){case A.Left:this.sprite.textures=[this.textureMap.right_1,this.textureMap.right_2,this.textureMap.right_3,this.textureMap.right_4,this.textureMap.right_5],this.sprite.scale.set(-1,1);break;case A.Right:this.sprite.textures=[this.textureMap.right_1,this.textureMap.right_2,this.textureMap.right_3,this.textureMap.right_4,this.textureMap.right_5],this.sprite.scale.set(1,1);break;case A.Up:this.sprite.textures=[this.textureMap.up_1,this.textureMap.up_2,this.textureMap.up_3,this.textureMap.up_4,this.textureMap.up_5],this.sprite.scale.set(1,1);break;case A.Down:this.sprite.textures=[this.textureMap.down_1,this.textureMap.down_2,this.textureMap.down_3,this.textureMap.down_4,this.textureMap.down_5],this.sprite.scale.set(1,1);break}}get moveTarget(){return this._moveTarget}handleKeydown(s){this.keyEvent.some(t=>t==s.code)||(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(s.code)?(this.moveTarget={ArrowLeft:"Left",ArrowRight:"Right",ArrowUp:"Up",ArrowDown:"Down"}[s.code],this.keyEvent.push(s.code)):s.code=="Space"&&this.parent.parent.onCreateBubble(this.gridX,this.gridY,this.bubbleStyle,this.power))}handleKeyup(s){if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(s.code))switch(this.sprite.stop(),this.keyEvent=this.keyEvent.filter(t=>t!=s.code),this.keyEvent[this.keyEvent.length-1]){case"ArrowLeft":this.moveTarget=A.Left;break;case"ArrowRight":this.moveTarget=A.Right;break;case"ArrowUp":this.moveTarget=A.Up;break;case"ArrowDown":this.moveTarget=A.Down;break;default:this.moveTarget=A.None}}onUpdate(){if(this.moveTarget=="None"){this.sprite.gotoAndStop(4);return}else this.sprite.playing||this.sprite.play();let s=this.x,t=this.y;switch(this.moveTarget){case"Left":s-=this.speed;break;case"Right":s+=this.speed;break;case"Up":t-=this.speed;break;case"Down":t+=this.speed;break}let o=Math.floor(s/c),n=Math.floor(t/L);const h=this.parent.parent;h.me==this&&h.iCanGo(o,n,s,t)}}function Qe(){const e=g.shared.resources[m.item_61].texture,s=g.shared.resources[m.item_62].texture,t=g.shared.resources[m.item_63].texture,o=(n,h=0,b=0,d,u)=>new l(n,new i(h,b,d||n.width,u||n.height),void 0,void 0,void 0,{x:0,y:1});return{[K.TGamePropEnum_NONE]:o(t),[K.TGamePropEnum_LOTION]:o(e),[K.TGamePropEnum_BUBBLES]:o(s),[K.TGamePropEnum_SHOSE]:o(t)}}class Ve extends C{constructor(s){super();const t=new v(te().shadow);t.anchor.set(.5,1),t.y=-4,t.x=c/2-1;const o=new v(Qe()[s]);o.y=-10,this.addChild(t),this.addChild(o)}}function we(){const e=g.shared.resources["assets/map_flopy_tile2.png"].texture,s=g.shared.resources[m.map_pirate_tile2].texture,t=g.shared.resources[m.map_pirate_tile6].texture,o=g.shared.resources[m.map_pirate_object1].texture,n=g.shared.resources[m.item_61].texture,h=g.shared.resources[m.item_62].texture,b=g.shared.resources[m.item_63].texture,d=(u,a=0,f=0,p,w)=>new l(u,new i(a,f,p||u.width,w||u.height),void 0,void 0,void 0,{x:0,y:1});return{map_flopy_tile2_1:new l(e,new i(0,0,40,40)),map_pirate:{floor1:d(s,0,0,41,40),floor2:d(s,40,0,41,40),floor3:d(s,81,0,41,40),floor4:d(s,121,0,41,40),floor5:d(s,160,0,40,40),light:d(t,320,0,40,160),pirate:d(t,0,0,80,160),pirate2:d(t,80,0,80,160),pirate3:d(t,160,0,120,160),house:d(t,280,0,40,80),stone:d(t,280,80,40,80),cask:d(t,360,80,40,80),b1:d(t,400,80,40,80),b2:d(t,440,80,40,80),b3:d(t,480,80,40,80),b4:d(t,520,80,40,80),b5:d(t,560,80,40,80),b6:d(t,360,0,40,80),b7:d(t,400,0,40,80),b8:d(t,440,0,40,80),b9:d(t,480,0,40,80),b10:d(t,520,0,40,80),box1:d(o),item_61:d(n),item_62:d(h),item_63:d(b)}}}class Ze extends P{constructor(){super();_(this,"io");_(this,"bubbles",[]);_(this,"map");_(this,"content");_(this,"persons",[]);_(this,"me");this.background=679865;const s=new F,t=(a,f,p,w,k,y,B)=>{s.lineStyle({color:k,width:1}),s.beginFill(y),s.drawRoundedRect(a,f,p,w,B),s.endFill()};t(0,0,E*c+20,T*c+20,3308466,0,8),t(5,5,E*c+10,T*c+10,4473162,6907762,8),t(10,10,E*c,T*c,4473162,0,8),s.x=10,s.y=35,this.addChild(s);const o=new F;o.lineStyle({color:19091,width:1}),o.beginFill(163544),o.drawRoundedRect(0,0,155,540,8),o.endFill(),o.x=638,o.y=35,this.addChild(o);const n=new He;n.x=645,n.y=45,this.addChild(n);const h=be,b=new C,d=new F;d.beginFill(16724736),d.drawRoundedRect(0,0,c*$,L*X,8),d.endFill(),b.mask=d,b.x=20,b.y=45,b.addChild(d),this.addChild(b);const u=this.content=new C;u.x=20,u.y=45,this.addChild(u),h.forEach((a,f)=>{a.forEach((p,w)=>{const k=new v(we().map_pirate[p.floor]);if(k.x=w*c,k.y=f*c+c,k.zIndex=0,p.top){const y=new v(we().map_pirate[p.top]);y.x=w*c,y.y=f*c+c,y.zIndex=f*10+1,p.block=y,u.addChild(y)}b.addChild(k)})}),this.map=be}async onCreateBubble(s,t,o,n){this.bubbles.some(h=>h.gridX==s&&h.gridY==t)||this.io.emit("putBubbles",null,()=>null)}async checkBoomt(s){const t=[s],o=[],n=[];for(;;){const h=t.shift();let b=0,d=0,u=0,a=0;if(!h)break;const{gridX:f,gridY:p}=h;for(;f+d+1!=$;){const w=this.map[p][f+d+1];if(w){if(o.some(y=>y==w))break;if(w.type)break;if(w.top){o.push(w),d++;break}}const k=this.bubbles.find(y=>y.gridX==f+d+1&&y.gridY==p);if(k&&!n.some(y=>y.bubble==k)&&t.push(k),d++,d==h.power)break}for(;;){const w=f-b-1,k=p;if(w<0)break;const y=this.map[k][w];if(y){if(o.some(S=>S==y))break;if(y.type)break;if(y.top){o.push(y),b++;break}}const B=this.bubbles.find(S=>S.gridX==w&&S.gridY==k);if(B&&!n.some(S=>S.bubble==B)&&t.push(B),b++,b==h.power)break}for(;;){const w=f,k=p-u-1;if(k<0)break;const y=this.map[k][w];if(y){if(o.some(S=>S==y))break;if(y.type)break;if(y.top){o.push(y),u--;break}}const B=this.bubbles.find(S=>S.gridX==w&&S.gridY==k);if(B&&!n.some(S=>S.bubble==B)&&t.push(B),u++,u==h.power)break}for(;;){const w=f,k=p+a+1;if(k==X)break;const y=this.map[k][w];if(y){if(o.some(S=>S==y))break;if(y.type)break;if(y.top){o.push(y),a++;break}}const B=this.bubbles.find(S=>S.gridX==w&&S.gridY==k);if(B&&!n.some(S=>S.bubble==B)&&t.push(B),a++,a==h.power)break}n.push({bubble:h,left:b,right:d,top:u,bottom:a})}o.forEach(h=>{var b;if(!!h.block&&(h.top="",(b=h.block)==null||b.parent.removeChild(h.block),h.prop)){const d=new Ve(h.prop);d.x=h.block.x,d.y=h.block.y,this.addChild(d)}}),n.forEach(h=>{const{bubble:b,left:d,right:u,top:a,bottom:f}=h;b.boom(d,u,a,f),this.bubbles=this.bubbles.filter(p=>b!=p)})}iCanGo(s,t,o,n){if(!this.me)return;let h=Math.floor((o-c/2)/c),b=Math.floor((n-c/2)/L);if(s<0||$<=s||t<0||X<=t||h<0||$<=h||b<0||X<=b)return!1;const d=new i(o-c/2,n-c/2,c,c);function u(p,w){const k=Math.abs((p.left+p.right)/2-(w.left+w.right)/2),y=Math.abs((p.top+p.bottom)/2-(w.top+w.bottom)/2),B=(p.width+w.width)/2,S=(p.height+w.height)/2;return k<B&&y<S}const a=this.me,f=a.moveTarget;if(a.gridY+1<X&&f=="Down"){if((this.map[a.gridY+1][a.gridX].block||this.bubbles.some(p=>p.gridX==a.gridX&&p.gridY==a.gridY+1))&&u(d,new i(a.gridX*c,(a.gridY+1)*c,c,c)))return;(a.gridX>0&&(this.map[a.gridY+1][a.gridX-1].block||this.bubbles.some(p=>p.gridX==a.gridX-1&&p.gridY==a.gridY+1))&&u(d,new i((a.gridX-1)*c,(a.gridY+1)*c,c,c))||a.gridX<$-1&&(this.map[a.gridY+1][a.gridX+1].block||this.bubbles.some(p=>p.gridX==a.gridX+1&&p.gridY==a.gridY+1))&&u(d,new i((a.gridX+1)*c,(a.gridY+1)*c,c,c)))&&(o=c*s+c/2)}if(a.gridY>0&&f=="Up"){if((this.map[a.gridY-1][a.gridX].block||this.bubbles.some(p=>p.gridX==a.gridX&&p.gridY==a.gridY-1))&&u(d,new i(a.gridX*c,(a.gridY-1)*c,c,c)))return;(a.gridX>0&&(this.map[a.gridY-1][a.gridX-1].block||this.bubbles.some(p=>p.gridX==a.gridX-1&&p.gridY==a.gridY-1))&&u(d,new i((a.gridX-1)*c,(a.gridY-1)*c,c,c))||a.gridX<$-1&&(this.map[a.gridY-1][a.gridX+1].block||this.bubbles.some(p=>p.gridX==a.gridX+1&&p.gridY==a.gridY-1))&&u(d,new i((a.gridX+1)*c,(a.gridY-1)*c,c,c)))&&(o=c*s+c/2)}if(a.gridX+1<$&&f=="Right"){if((this.map[a.gridY][a.gridX+1].block||this.bubbles.some(p=>p.gridX==a.gridX+1&&p.gridY==a.gridY))&&u(d,new i((a.gridX+1)*c,a.gridY*c,c,c)))return;(a.gridY>0&&(this.map[a.gridY-1][a.gridX+1].block||this.bubbles.some(p=>p.gridX==a.gridX+1&&p.gridY==a.gridY-1))&&u(d,new i((a.gridX+1)*c,(a.gridY-1)*c,c,c))||a.gridY<X-1&&(this.map[a.gridY+1][a.gridX+1].block||this.bubbles.some(p=>p.gridX==a.gridX+1&&p.gridY==a.gridY+1))&&u(d,new i((a.gridX+1)*c,(a.gridY+1)*c,c,c)))&&(n=c*t+c/2)}if(a.gridX>0&&f=="Left"){if((this.map[a.gridY][a.gridX-1].block||this.bubbles.some(p=>p.gridX==a.gridX-1&&p.gridY==a.gridY))&&u(d,new i((a.gridX-1)*c,a.gridY*c,c,c)))return;(a.gridY>0&&(this.map[a.gridY-1][a.gridX-1].block||this.bubbles.some(p=>p.gridX==a.gridX-1&&p.gridY==a.gridY-1))&&u(d,new i((a.gridX-1)*c,(a.gridY-1)*c,c,c))||a.gridY<X-1&&(this.map[a.gridY+1][a.gridX-1].block||this.bubbles.some(p=>p.gridX==a.gridX-1&&p.gridY==a.gridY+1))&&u(d,new i((a.gridX-1)*c,(a.gridY+1)*c,c,c)))&&(n=c*t+c/2)}this.me.x=o,this.me.y=n,this.me.gridX=Math.floor(o/c),this.me.gridY=Math.floor(n/L),this.me.hasChange=!0}onUpdate(){this.persons.forEach(s=>{s.zIndex=s.gridY*10+2})}onEnter(){return this.io=new ee(Ce,{query:{username:Y.name,roomId:Y.roomId},transports:["websocket"],forceNew:!0}),this.loop(),this.io.on("disconnect",()=>{}),this.io.on("boomBubble",s=>{s.forEach(t=>{const o=new ue(x().RANBOW,t.gridX,t.gridY,1);o.zIndex=1,this.content.addChild(o),o.boom(t.left,t.right,t.top,t.bottom)})}),P.prototype.onEnter.call(this)}onLeave(){return this.io.close(),P.prototype.onLeave.call(this)}getSyncPack(){return new Promise(s=>{this.io.once("sync",s)})}async loop(){const s=await this.getSyncPack(),t=new Re(s.players.map(n=>({name:n.name,icon:x().BLACK[0],status:n.status})));t.x=645,t.y=85,this.addChild(t);const o=this.persons=s.players.map(n=>{const h=new qe(n.gridX,n.gridY,n.name,n.role,Y.name==n.name);return this.content.addChild(h),Y.name==n.name&&(this.me=h,document.onkeydown=h.handleKeydown.bind(h),document.onkeyup=h.handleKeyup.bind(h),setInterval(()=>{h.hasChange&&this.io.emit("changeprop",{name:Y.name,gridX:h.gridX,gridY:h.gridY,x:h.x,y:h.y,moveTarget:h.moveTarget}),h.hasChange=!1},30)),h});for(s.props.forEach(n=>{this.map[n.gridY][n.gridX].prop=n.props});;){const n=await this.getSyncPack();n.players.forEach((u,a)=>{Y.name!=u.name&&(o[a].x=u.x,o[a].y=u.y,o[a].gridX=u.gridX,o[a].gridY=u.gridY,o[a].moveTarget=u.moveTarget)});const h={};for(let u of n.bubbles){const a=`${u.gridX}_${u.gridY}`;h[a]=u}const b={};this.bubbles=this.bubbles.filter(u=>{const a=`${u.gridX}_${u.gridY}`;return b[a]=u,h[a]?!0:(u.parent.removeChild(u),!1)}),n.bubbles.forEach(u=>{const a=`${u.gridX}_${u.gridY}`;if(!b[a]){const f=new ue(x().RANBOW,u.gridX,u.gridY,u.power);f.zIndex=1,this.content.addChild(f),this.bubbles.push(f)}});const d={};n.props.forEach(u=>{d[`${u.gridX}_${u.gridY}`]=u}),this.map.forEach((u,a)=>{u.forEach((f,p)=>{const w=`${p}_${a}`;d[w]||f.block&&(f.block.parent.removeChild(f.block),f.block=void 0)})})}}}class me extends P{constructor(){super();_(this,"io");_(this,"messageBox");_(this,"starBtn");_(this,"roomInfo");_(this,"me");const s=new O("\u79BB\u5F00\u623F\u95F4",120,60);s.x=G-s.width-25,s.y=22,s.on("click",this.handleOnLeaveRoom.bind(this)),this.addChild(s),this.background=1278710;const t=new F,o=(d,u,a,f,p,w,k)=>{t.lineStyle({color:p,width:1}),t.beginFill(w),t.drawRoundedRect(d,u,a,f,k),t.endFill()};o(5,-10,455,40,867711,738486,8),o(5,35,510,515,867711,180725,8),o(5+1,35+1,510-2,515-2,16777215,180725,8),o(465,5,328,555,867711,420552,8),o(465+1,5+1,328-2,555-2,4099785,420552,8),o(0,j-35,800,35,867711,474501,0),o(-1,j-35+1,800+2,35,1729974,474501,0),o(480,240,300,215,867711,20652,8),o(22,55,426,30,292265,37332,4),o(20,90,430,295,4186367,280469,4),this.addChild(t);const n=new v(g.shared.resources[m.bg].texture);n.x=480,n.y=15,n.width=300,n.height=210,this.addChild(n),this.messageBox=new ie(430,148,20649,1),this.messageBox.x=20,this.messageBox.y=390,this.addChild(this.messageBox);const h=this.starBtn=new oe(g.shared.resources[m.btn_room_ready].texture);h.x=535,h.y=480,h.on("click",this.handleOnStartBtnClick.bind(this)),this.addChild(h);const b=new Ae;b.x=488,b.y=250,b.onSelected(d=>{this.io.emit("choosePlayer",d,()=>{})}),this.addChild(b)}handleOnStartBtnClick(){!this.me||!this.roomInfo||(this.me.isMaster?this.roomInfo.players.some(s=>s.status==J.PENDING&&!s.isMaster)?Ge.toast("\u8FD8\u6709\u73A9\u5BB6\u672A\u51C6\u5907"):this.io.emit("start",void 0,()=>null):this.io.emit("ready",void 0,()=>null))}handleOnLeaveRoom(){I.back()}onEnter(){return this.io=new ee(Ye,{query:{username:Y.name,roomId:Y.roomId},transports:["websocket"],forceNew:!0}),this.io.on("sync",this.sync.bind(this)),this.io.on("message",s=>{this.messageBox.push(s)}),this.io.on("disconnect",()=>{}),this.io.on("gameStart",()=>{I.push(Ze)}),P.prototype.onEnter.call(this)}sync(s){this.roomInfo=s,console.info(s),this.renderRoomName(s),this.renderPlayCard(s);const t=this.me=s.players.find(o=>o.name==Y.name);t||I.back(),(t==null?void 0:t.isMaster)&&(this.starBtn.baseTexture=this.starBtn.texture=g.shared.resources[m.btn_room_start].texture)}getSyncPack(){return new Promise(s=>{this.io.once("sync",s)})}async loop(){await this.getSyncPack(),await new Promise(s=>{this.io.once("sync",s)})}renderRoomName(s){const t=new z(s.name,new D({align:"center",fontSize:12,fill:"#fff"}));t.x=30,t.y=63,t.zIndex=10,this.addChild(t)}renderPlayCard(s){for(let t=0;t<8;t++){const o=new ze(t<s.totalPlayer,s.players[t]);o.x=25+t%4*(o.width+4),o.y=Math.floor(t/4)*o.height+92,this.addChild(o)}}onLeave(){return this.io.close(),P.prototype.onLeave.call(this)}}class Je extends v{constructor(s,t,o){super(g.shared.resources[m.room_card_bg].texture);_(this,"statusSprite");_(this,"roomId");this.roomId=s;const n=new F;n.lineStyle({color:35525,width:2}),n.beginFill(365792),n.drawRoundedRect(0,0,110,40,4),n.endFill(),n.x=110,n.y=18,this.addChild(n);const h=new z(t,new D({align:"left",fontSize:14,wordWrapWidth:n.width-8,wordWrap:!0,breakWords:!0,fill:H([255/255,255/255,255/255])}));h.x=4,h.y=4,n.addChild(h);const b=new v(g.shared.resources[m.room_card_default_img].texture);b.x=10,b.y=15,this.addChild(b),this.interactive=!0,this.cacheAsBitmap=!0,this.roomStatus=o}set roomStatus(s){const t={[Z.IN_GAME]:g.shared.resources[m.room_card_status_in_game].texture,[Z.WAITING]:g.shared.resources[m.room_card_status_waiting].texture}[s];this.statusSprite?this.statusSprite.texture=t:(this.statusSprite=new v(t),this.statusSprite.x=110,this.statusSprite.y=80,this.addChild(this.statusSprite))}}class xe extends P{constructor(){super();_(this,"io");_(this,"roomList",[]);_(this,"timer");_(this,"roomListBox");_(this,"pageNum",0);_(this,"messageBox");this.background=2526936,this.backgroundImage=g.shared.resources[m.hall].texture;const s=new O("\u521B\u5EFA\u623F\u95F4",120,60);s.x=G-s.width-25,s.y=22,s.on("click",this.handleOnCreateRoom.bind(this)),this.addChild(s);const t=new F;t.lineStyle({color:0,alpha:.25,width:1}),t.beginFill(0,.2),t.drawRoundedRect(0,0,760,340,4),t.endFill(),t.lineStyle({color:0,alpha:.3,width:1}),t.beginFill(0,.3),t.drawRoundedRect(15,15,730,275,4),t.endFill(),t.x=G/2-t.width/2,t.y=95,this.addChild(t);const o=new C,n=new oe(M().btn_pre_page);n.interactive=!0,n.on("click",this.prePage.bind(this)),o.addChild(n);const h=new oe(M().btn_next_page);h.interactive=!0,h.on("click",this.nextPage.bind(this)),h.x=n.width+10,o.addChild(h),o.x=G/2-o.width/2,o.y=400,this.addChild(o),this.roomListBox=new C,this.roomListBox.x=45,this.roomListBox.y=115,this.addChild(this.roomListBox),this.messageBox=new ie(760,110),this.messageBox.x=G/2-this.messageBox.width/2,this.messageBox.y=j-this.messageBox.height-40,this.addChild(this.messageBox)}handleOnCreateRoom(){const s=prompt("\u8BF7\u8F93\u5165\u623F\u95F4\u540D\u79F0");s&&this.io.emit("createRoom",s,t=>{console.info("\u521B\u5EFA\u6210\u529F",t),Y.roomId=t.id,I.push(me)})}queryRoom(){this.io.emit("getRoomList",s=>{this.roomList=s,this.rerenderRoomList(),this.timer=setTimeout(()=>{this.queryRoom()},2e3)})}prePage(){this.pageNum!=0&&(this.pageNum--,this.rerenderRoomList())}nextPage(){Math.floor(this.roomList.length/6)!=this.pageNum&&(this.pageNum++,this.rerenderRoomList())}onEnter(){return this.io=ee(Le,{query:{username:Y.name},transports:["websocket"],forceNew:!0}),this.io.on("message",s=>{console.info("message=>",s),this.messageBox.push(s)}),this.io.on("connect",()=>{this.queryRoom()}),P.prototype.onEnter.call(this)}onLeave(){return clearInterval(this.timer),this.roomList=[],this.io.disconnect(),P.prototype.onLeave.call(this)}async rerenderRoomList(){this.roomListBox.removeChildren(),this.pageNum=Math.min(this.pageNum,Math.floor(this.roomList.length/6)),this.roomList.slice(this.pageNum*6,(this.pageNum+1)*6).forEach((s,t)=>{const o=new Je(s.id,s.name,s.status);o.x=t%3*(o.width+8),o.y=Math.floor(t/3)*(o.height+8),o.on("click",()=>{Y.roomId=s.id,I.push(me)}),this.roomListBox.addChild(o)})}}class Ne extends P{constructor(){super();const s=new v(g.shared.resources[m.bg].texture);s.anchor.set(.5,.5),s.scale.x=.7,s.scale.y=.7,s.x=this.width/2,s.y=this.height/2,this.addChild(s);const t=new O("\u5F00\u59CB\u6E38\u620F",120,60);t.on("click",()=>{if(!Y.name){const o=prompt("\u5C0A\u59D3\u5927\u540D");if(!o)return;location.search=U.stringify(Object.assign(U.parse(location.search.replace("?","")),{name:o})),Y.name=o}I.push(xe)}),t.x=this.width/2-t.width/2,t.y=this.height-100-t.height/2,this.addChild(t),setTimeout(()=>{Y.name&&I.push(xe)},100)}}document.body.appendChild(I.view);I.view.style.margin="auto";I.view.style.boxShadow="0 0 30px rgba(0,0,0,.3)";I.view.style.width=G*1+"px";I.view.style.height=j*1+"px";document.body.style.background="#f5f5f5";document.body.style.margin="0px";document.body.style.height="100%";document.body.style.display="flex";document.body.style.justifyContent="center";document.documentElement.style.height="100%";Fe.forEach(g.shared.add.bind(g.shared));g.shared.onComplete.once(()=>{I.push(Ne)});g.shared.load();
